{% extends "base.html" %}
{% block title %}–ê—Ä–µ–Ω–∞ - {{ player.username }}{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto px-4 py-20">
    <h1 class="hero-title mb-12 text-center">‚öîÔ∏è –ê—Ä–µ–Ω–∞</h1>
    
    <!-- –¢–í–û–ò –¢–ê–ù–ö–ò -->
    <div class="glass-panel p-8 mb-8">
        <h2 class="text-3xl font-bold mb-6">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–Ω–∫:</h2>
        <div class="flex flex-wrap gap-4">
            {% set player_tanks = get_player_tanks(player.id) %}
            {% for tank_id in player_tanks %}
            {% set tank = tanks[tank_id] %}
            <button onclick="queueBattle('{{ tank_id }}', {{ tank.tier }})" 
                    class="tank-select-btn p-6 rounded-2xl font-bold flex-1 min-w-[200px] 
                           bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-400 hover:to-purple-500">
                üá∑üá∫ {{ tank.name }}<br>
                <span class="text-lg">–£—Ä. {{ tank.tier }}</span>
            </button>
            {% endfor %}
            <!-- –ò–ò –ë–û–ô -->
            <button onclick="queueBattle('ai', 1)" 
                    class="tank-select-btn p-6 rounded-2xl font-bold flex-1 min-w-[200px] 
                           bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-400 hover:to-green-500">
                ü§ñ –ë–æ–π —Å –ò–ò<br><span class="text-lg">–£—Ä. 1 (–ª–µ–≥–∫–æ)</span>
            </button>
        </div>
    </div>

    <!-- –û–ñ–ò–î–ê–ù–ò–ï –ò–ì–†–û–ö–û–í -->
    <div id="waiting" class="glass-panel p-8 mb-8 hidden">
        <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
            <i class="fas fa-clock animate-spin"></i> –í –æ—á–µ—Ä–µ–¥–∏...
        </h2>
        <div id="queueStatus" class="text-2xl text-center">
            –ñ–¥—ë—Ç:<br>
            <span id="queueTiers">1 —É—Ä–æ–≤–Ω—è: 0 –∏–≥—Ä–æ–∫–æ–≤</span>
        </div>
        <button onclick="cancelQueue()" class="mt-6 bg-red-500 hover:bg-red-400 text-white py-3 px-8 rounded-2xl font-bold">
            ‚ùå –í—ã–π—Ç–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        </button>
    </div>

    <!-- –ë–û–ô -->
    <div id="battle" class="glass-panel p-12 hidden text-center">
        <div class="text-6xl mb-8 animate-pulse">‚öîÔ∏è</div>
        <h2 id="battleTitle" class="text-4xl font-black mb-8"></h2>
        <div id="battleResult" class="text-3xl mb-8"></div>
        <button onclick="newBattle()" class="bg-gradient-to-r from-emerald-500 to-green-600 text-white py-4 px-12 rounded-2xl font-bold text-xl">
            –ï—â—ë –±–æ–π!
        </button>
    </div>
</div>

<script>
let currentQueue = null;
let liveInterval;

async function queueBattle(tank_id, tier) {
    currentQueue = {tank_id, tier};
    document.getElementById('waiting').classList.remove('hidden');
    
    // LIVE —Å—Ç–∞—Ç—É—Å –æ—á–µ—Ä–µ–¥–∏
    liveInterval = setInterval(async () => {
        const res = await fetch('/api/queue-status?tier=' + tier);
        const data = await res.json();
        document.getElementById('queueTiers').innerHTML = 
            `1 —É—Ä–æ–≤–Ω—è: ${data.tier1} | 2 —É—Ä–æ–≤–Ω—è: ${data.tier2} | 3 —É—Ä–æ–≤–Ω—è: ${data.tier3}`;
    }, 1000);
    
    // –°–∏–º—É–ª—è—Ü–∏—è –±–æ—è —á–µ—Ä–µ–∑ 3-10 —Å–µ–∫
    setTimeout(() => {
        clearInterval(liveInterval);
        showBattleResult(tank_id, tier);
    }, Math.random() * 7000 + 3000);
}

function showBattleResult(tank_id, tier) {
    document.getElementById('waiting').classList.add('hidden');
    document.getElementById('battle').classList.remove('hidden');
    
    const win = Math.random() > 0.3; // 70%ÂãùÁéá
    document.getElementById('battleTitle').innerHTML = win ? '‚úÖ –ü–û–ë–ï–î–ê!' : '‚ùå –ü–û–†–ê–ñ–ï–ù–ò–ï';
    document.getElementById('battleResult').innerHTML = win ? 
        '+15,000 —Å–µ—Ä–µ–±—Ä–∞!' : '+2,000 —Å–µ—Ä–µ–±—Ä–∞';
    
    // LIVE –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
}
</script>
{% endblock %}
